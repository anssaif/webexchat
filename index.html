<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>NationalVision Doctor Chat</title>
    <style>
      body {
        margin: 0;
        font-family: "Segoe UI", Helvetica, Arial, sans-serif;
      }
    </style>
  </head>

  <body>
    <h1>V1.6</h1>
    <div
      id="divicw"
      data-bind="FB77A4AB-9361-49FD-8473-6B38F9A1A5EA"
      data-org=""
      data-guid="9029a5de-a658-4078-864c-cf8264b0dda0"
    ></div>

    <script>
      /**
       * Safe IMI Chat loader (Teams and Webex compatible)
       * - Prevents cross-origin SecurityError
       * - Adds logging and graceful fallback
       * - Uses postMessage() for iframe communication
       */

      var i = {
        t: function () {
          var chatScriptUrl = "https://media.imi.chat/widget/js/imichatinit.js";
          console.log("[IMIChat] Loading chat widget script:", chatScriptUrl);

          try {
            var xhr = new XMLHttpRequest();
            xhr.onreadystatechange = function () {
              if (this.readyState === 4) {
                var container = document.getElementById("divicw");

                if (this.status === 200) {
                  console.log("[IMIChat] Widget script loaded successfully.");
                  var s = document.createElement("script");
                  s.innerHTML = this.responseText;
                  container.parentNode.insertBefore(s, container.nextSibling);
                } else {
                  console.warn(
                    "[IMIChat] Failed to load chat script, status:",
                    this.status,
                    "- Showing TLS alert iframe fallback."
                  );
                  i.o(container);
                }
              }
            };

            xhr.open("GET", chatScriptUrl, true);
            xhr.send();
          } catch (err) {
            console.error("[IMIChat] Exception while loading script:", err);
          }
        },

        // show fallback iframe safely
        o: function (container) {
          console.log("[IMIChat] Creating TLS alert iframe...");

          var iframe = document.createElement("iframe");
          iframe.id = "tls_al_frm";
          iframe.src = "https://nvichat.netlify.app/tls_alert.html"; // hosted separately
          iframe.style =
            "overflow:hidden;height:208px;width:394px;position:fixed;right:48px;bottom:12px;z-index:99999;border:none;display:block;";
          document.body.appendChild(iframe);

          // listen for close event from iframe
          window.addEventListener("message", function (event) {
            if (event.origin !== "https://nvichat.netlify.app") return;
            if (event.data.action === "close_tls_alert") {
              console.log("[IMIChat] Closing TLS alert iframe.");
              i.s();
            }
          });
        },

        // remove fallback iframe
        s: function () {
          var frame = document.getElementById("tls_al_frm");
          if (frame) {
            frame.remove();
          }
        },
      };

      // Initialize widget load
      i.t();
    </script>
  </body>
</html>
